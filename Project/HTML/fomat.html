<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>WebSocket Chat Test</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
      body {
        font-family: sans-serif;
        padding: 20px;
      }
      #messages {
        border: 1px solid #ccc;
        height: 300px;
        overflow-y: scroll;
        padding: 10px;
      }
      .me {
        color: blue;
      }
      .other {
        color: green;
      }
    </style>
  </head>
  <body>
    <h2>Test Chat WebSocket</h2>

    <label>ID ng∆∞·ªùi nh·∫≠n:</label>
    <input type="number" id="receiverId" />
    <button onclick="startChat()">B·∫Øt ƒë·∫ßu chat</button>
    <br /><br />

    <label>Tin nh·∫Øn:</label>
    <input type="text" id="messageInput" />
    <button onclick="sendMessage()">G·ª≠i</button>
    <br /><br />

    <div id="messages"></div>

    <script>
      const token = localStorage.getItem("accessToken");
      const userId = JSON.parse(atob(token.split(".")[1])).sub;
      let currentReceiverId = null;
      let stompClient = null;
      let subscribedChannel = "";

      const socket = new SockJS("http://localhost:8080/ws");
      stompClient = Stomp.over(socket);
      stompClient.connect({ Authorization: "Bearer " + token }, () => {
        console.log("‚úÖ ƒê√£ k·∫øt n·ªëi WebSocket");
      });

      function createChatChannel(id1, id2) {
        const min = Math.min(id1, id2);
        const max = Math.max(id1, id2);
        return "/topic/chat/" + min + "-" + max;
      }

      function startChat() {
        const input = document.getElementById("receiverId").value;
        if (!input) return alert("‚ö†Ô∏è Nh·∫≠p ID ng∆∞·ªùi nh·∫≠n");
        currentReceiverId = parseInt(input);
        const channel = createChatChannel(userId, currentReceiverId);

        if (subscribedChannel !== channel) {
          stompClient.subscribe(channel, (message) => {
            const msg = JSON.parse(message.body);
            console.log("üì® Nh·∫≠n ƒë∆∞·ª£c response:", msg);
            showMessage(msg, false);
          });
          subscribedChannel = channel;
          console.log("üì° Subscribed to:", channel);
        }
      }

      function sendMessage() {
        const content = document.getElementById("messageInput").value.trim();
        if (!currentReceiverId || !content)
          return alert("‚ö†Ô∏è Ch∆∞a nh·∫≠p tin nh·∫Øn ho·∫∑c ng∆∞·ªùi nh·∫≠n");

        stompClient.send(
          "/app/message.private",
          {},
          JSON.stringify({
            receiverId: currentReceiverId,
            message: content,
            token: token,
          })
        );

        // üëá S·ª≠a l·∫°i ƒë·ªÉ d√πng ƒë√∫ng ƒë·ªãnh d·∫°ng
        showMessage({ message: content }, true);
        document.getElementById("messageInput").value = "";
      }

      function showMessage(msg, isMe) {
        const div = document.createElement("div");
        div.className = isMe ? "me" : "other";
        div.innerText = (isMe ? "B·∫°n: " : "Ng∆∞·ªùi kh√°c: ") + msg.message;
        document.getElementById("messages").appendChild(div);
      }
    </script>
  </body>
</html>
